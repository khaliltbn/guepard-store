name: CI

on:
  push:
    branches:
      - main
      - develop
      - "*"
  pull_request:
    types: [opened, synchronize, reopened]

env:
  # Used by Guepard CLI installed via Homebrew (guepard login -c ...)
  GUEPARD_API_TOKEN: ${{ secrets.GUEPARD_API_TOKEN }}

jobs:
  frontend-tests:
    name: Unit tests - frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Install dependencies (frontend)
        working-directory: components/frontend
        run: pnpm install --frozen-lockfile

      - name: Run frontend unit tests
        working-directory: components/frontend
        run: pnpm test:run

      - name: CI summary - frontend
        if: always()
        run: |
          {
            echo "### Frontend unit tests";
            echo "";
            echo "- Status: ${{ job.status }}";
            echo "- Directory: \`components/frontend\`";
            echo "- Command: \`pnpm test:run\`";
          } >> "$GITHUB_STEP_SUMMARY"

  api-tests:
    name: Unit tests - API
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies (api)
        working-directory: components/api
        run: pnpm install --frozen-lockfile

      - name: Run API unit tests
        working-directory: components/api
        run: pnpm test:unit

      - name: CI summary - API
        if: always()
        run: |
          {
            echo "### API unit tests";
            echo "";
            echo "- Status: ${{ job.status }}";
            echo "- Directory: \`components/api\`";
            echo "- Command: \`pnpm test\` (Bun test runner)";
          } >> "$GITHUB_STEP_SUMMARY"

  db-integration-tests:
    name: DB integration tests (clone from snapshot, validate)
    needs:
      - frontend-tests
      - api-tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install Guepard CLI via Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew tap guepard-corp/guepard
          brew install guepard

      - name: Guepard CLI login
        env:
          GUEPARD_API_TOKEN: ${{ env.GUEPARD_API_TOKEN }}
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "ðŸ” Executing: guepard logout"
          guepard logout || true
          echo "ðŸ” Executing: guepard login -c *** (token hidden)"
          guepard login -c "$GUEPARD_API_TOKEN"

      - name: Install jq
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "ðŸ” Executing: guepard usage to test login"
          echo "$(guepard usage)"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Select base deployment
        id: base_deployment
        run: |
          set -e
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          # List deployments as JSON and select the first CREATED deployment for repository 'Guepard-shop2'
          echo "ðŸ” Executing: guepard list deployments --json"
          DEPLOYMENTS_JSON=$(guepard list deployments --json)
          echo "$DEPLOYMENTS_JSON" | jq '.' > /tmp/deployments.json
          BASE_DEPLOYMENT_ID=$(echo "$DEPLOYMENTS_JSON" | jq -r '.[] | select(.repository == "Guepard-shop2" and .status == "CREATED") | .id' | head -n 1)
          if [ -z "$BASE_DEPLOYMENT_ID" ]; then
            echo "No suitable base deployment found for repository 'Guepard-shop2'"
            exit 1
          fi
          echo "BASE_DEPLOYMENT_ID=$BASE_DEPLOYMENT_ID" >> "$GITHUB_ENV"
          echo "base_deployment_id=$BASE_DEPLOYMENT_ID" >> "$GITHUB_OUTPUT"

      - name: Start compute for base deployment
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          guepard compute start -x "$BASE_DEPLOYMENT_ID" || true

      - name: Get main branch ID
        id: branch
        run: |
          set -e
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "ðŸ” Executing: guepard list branches -x $BASE_DEPLOYMENT_ID --json"
          BRANCHES_JSON=$(guepard list branches -x "$BASE_DEPLOYMENT_ID" --json)
          echo "$BRANCHES_JSON" | jq '.' > /tmp/branches.json
          BRANCH_ID=$(echo "$BRANCHES_JSON" | jq -r '.[] | select(.branch_name == "main") | .id' | head -n 1)
          if [ -z "$BRANCH_ID" ]; then
            echo "No main branch found for deployment $BASE_DEPLOYMENT_ID"
            exit 1
          fi
          echo "BRANCH_ID=$BRANCH_ID" >> "$GITHUB_ENV"
          echo "branch_id=$BRANCH_ID" >> "$GITHUB_OUTPUT"

      - name: Create snapshot from main branch
        id: snapshot
        run: |
          set -e
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "Creating snapshot from main branch for CI testing..."
          COMMIT_MESSAGE="CI test snapshot - $(date -u +%Y%m%d-%H%M%S)"
          echo "ðŸ” Executing: guepard commit --message \"$COMMIT_MESSAGE\" --deployment-id $BASE_DEPLOYMENT_ID --branch-id $BRANCH_ID --json"
          COMMIT_JSON=$(guepard commit \
            --message "$COMMIT_MESSAGE" \
            --deployment-id "$BASE_DEPLOYMENT_ID" \
            --branch-id "$BRANCH_ID" \
            --json || true)
          echo "$COMMIT_JSON" | jq '.' > /tmp/commit.json || true
          # Extract commit_id from response (array format)
          COMMIT_ID=$(echo "$COMMIT_JSON" | jq -r '.[0].commit_id // empty')
          if [ -z "$COMMIT_ID" ] || [ "$COMMIT_ID" = "null" ]; then
            echo "Failed to create snapshot. Response:"
            echo "$COMMIT_JSON" | jq '.' || echo "$COMMIT_JSON"
            exit 1
          fi
          echo "Commit created: $COMMIT_ID"
          echo "Waiting for commit to appear in commits list..."
          # Wait for commit to appear in commits list (verify it's available)
          for i in {1..30}; do
            echo "ðŸ” Executing: guepard list commits -x $BASE_DEPLOYMENT_ID --json (attempt $i/30)"
            COMMITS_JSON=$(guepard list commits -x "$BASE_DEPLOYMENT_ID" --json || true)
            COMMIT_EXISTS=$(echo "$COMMITS_JSON" | jq -r ".[] | select(.id == \"$COMMIT_ID\") | .id" | head -n 1)
            if [ "$COMMIT_EXISTS" = "$COMMIT_ID" ]; then
              echo "Commit found in commits list, ready to use as snapshot"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Warning: Commit did not appear in commits list, but proceeding with commit_id as snapshot_id"
            else
              echo "Attempt $i/30: Waiting for commit to appear in commits list..."
              sleep 2
            fi
          done
          # commit_id from commit response = id in commits list = snapshot_id for cloning
          SNAPSHOT_ID="$COMMIT_ID"
          echo "Using commit_id as snapshot_id: $SNAPSHOT_ID"
          echo "SNAPSHOT_ID=$SNAPSHOT_ID" >> "$GITHUB_ENV"
          echo "snapshot_id=$SNAPSHOT_ID" >> "$GITHUB_OUTPUT"

      - name: Clone deployment from snapshot
        id: clone
        run: |
          set -e
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "ðŸ” Executing: guepard clone -x $BASE_DEPLOYMENT_ID -s $SNAPSHOT_ID --json"
          CLONE_JSON=$(guepard clone -x "$BASE_DEPLOYMENT_ID" -s "$SNAPSHOT_ID" --json)
          echo "$CLONE_JSON" | jq '.' > /tmp/clone.json
          CLONE_DEPLOYMENT_ID=$(echo "$CLONE_JSON" | jq -r '.deployment.id')
          CONNECTION_STRING=$(echo "$CLONE_JSON" | jq -r '.compute.connection_string // empty')
          if [ -z "$CLONE_DEPLOYMENT_ID" ]; then
            echo "Failed to capture clone deployment id"
            exit 1
          fi
          if [ -z "$CONNECTION_STRING" ] || [ "$CONNECTION_STRING" = "null" ]; then
            echo "Warning: connection_string not available in clone response, will fetch after compute is healthy"
          else
            echo "Connection string captured from clone response"
            echo "DB_CONNECTION_STRING=$CONNECTION_STRING" >> "$GITHUB_ENV"
            echo "db_connection_string=$CONNECTION_STRING" >> "$GITHUB_OUTPUT"
          fi
          echo "CLONE_DEPLOYMENT_ID=$CLONE_DEPLOYMENT_ID" >> "$GITHUB_ENV"
          echo "clone_deployment_id=$CLONE_DEPLOYMENT_ID" >> "$GITHUB_OUTPUT"

      - name: Start compute for base deployment
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          guepard compute start -x "$CLONE_DEPLOYMENT_ID" || true

      - name: Wait for clone compute to be healthy
        id: compute_ready
        run: |
          set -e
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "Waiting for compute of clone deployment $CLONE_DEPLOYMENT_ID to be healthy..."
          echo "Initial wait for compute to start initializing..."
          sleep 15
          for i in {1..20}; do
            echo "ðŸ” Executing: guepard compute status -x $CLONE_DEPLOYMENT_ID --json (attempt $i/20)"
            STATUS_JSON=$(guepard compute status -x "$CLONE_DEPLOYMENT_ID" --json 2>&1 || echo '{"error": "command_failed"}')
            if echo "$STATUS_JSON" | grep -q "502\|Bad Gateway\|Internal server error"; then
              echo "Attempt $i/20: Compute API returned error (still initializing), waiting 10s..."
            elif echo "$STATUS_JSON" | jq -e '.status' > /dev/null 2>&1; then
              HEALTHY=$(echo "$STATUS_JSON" | jq -r '.status // empty')
              if [ "$HEALTHY" = "Healthy" ]; then
                echo "Compute is healthy."
                # Update connection string from compute status if available
                COMPUTE_CONNECTION=$(echo "$STATUS_JSON" | jq -r '.connection_string // empty')
                if [ -n "$COMPUTE_CONNECTION" ] && [ "$COMPUTE_CONNECTION" != "null" ]; then
                  echo "Updating connection string from compute status"
                  echo "DB_CONNECTION_STRING=$COMPUTE_CONNECTION" >> "$GITHUB_ENV"
                  echo "db_connection_string=$COMPUTE_CONNECTION" >> "$GITHUB_OUTPUT"
                fi
                echo "Final connection string: $(echo "$DB_CONNECTION_STRING" | cut -c1-50)..."
                exit 0
              else
                echo "Attempt $i/20: Compute status is '$HEALTHY', waiting 10s..."
              fi
            else
              echo "Attempt $i/20: Unexpected response format: $(echo "$STATUS_JSON" | head -c 100)..."
            fi
            sleep 10
          done
          echo "Error: compute did not become healthy in time (waited ~3.5 minutes)"
          echo "Last status check response:"
          echo "$STATUS_JSON" | head -20
          exit 1

      - name: Install dependencies (api)
        env:
          DATABASE_URL: ${{ env.DB_CONNECTION_STRING }}
        working-directory: components/api
        run: pnpm install --frozen-lockfile

      - name: Run Prisma migrations against clone
        env:
          DATABASE_URL: ${{ env.DB_CONNECTION_STRING }}
        working-directory: components/api
        run: |
          if [ -z "$DATABASE_URL" ] || [ "$DATABASE_URL" = "null" ]; then
            echo "Error: DATABASE_URL is not set or is null"
            exit 1
          fi
          echo "Applying Prisma migrations to clone database..."
          echo "Using DATABASE_URL: $(echo "$DATABASE_URL" | cut -c1-60)..."
          export SHADOW_DATABASE_URL="${{ secrets.SHADOW_DATABASE_URL }}"

          echo "Using DATABASE_URL: $(echo "$DATABASE_URL" | cut -c1-60)..."
          bunx prisma migrate diff \
            --from-empty \
            --to-schema-datamodel prisma/schema.prisma \
            --script \
            --output prisma/migrations/000_baseline/migration.sql

          bunx prisma migrate resolve --applied 000_baseline

          bunx prisma migrate diff \
            --from-migrations prisma/migrations \
            --to-schema-datamodel prisma/schema.prisma \
            --shadow-database-url "$SHADOW_DATABASE_URL" \
            --script \
            --output prisma/migrations/test-feature/migration.sql

          bunx prisma migrate deploy

      - name: Seed data with new format after migrations
        env:
          DATABASE_URL: ${{ env.DB_CONNECTION_STRING }}
        working-directory: components/api
        run: |
          if [ -z "$DATABASE_URL" ] || [ "$DATABASE_URL" = "null" ]; then
            echo "Error: DATABASE_URL is not set or is null"
            exit 1
          fi
          echo "Seeding test data with new format..."
          echo "Using DATABASE_URL: $(echo "$DATABASE_URL" | cut -c1-60)..."
          export DATABASE_URL
          bunx prisma generate
          bun run prisma/integration/seed.ts

      - name: Run DB invariants tests
        env:
          # Use Guepard clone compute connection string directly as DATABASE_URL
          DATABASE_URL: ${{ env.DB_CONNECTION_STRING }}
        working-directory: components/api
        run: |
          if [ -z "$DATABASE_URL" ] || [ "$DATABASE_URL" = "null" ]; then
            echo "Error: DATABASE_URL is not set or is null"
            exit 1
          fi
          echo "Running Prisma DB invariants tests against $(echo "$DATABASE_URL" | cut -c1-60)..."
          export DATABASE_URL
          pnpm test:db

      - name: CI summary - database
        if: always()
        run: |
          {
            echo "### DB integration tests (clone from snapshot, validate)";
            echo "";
            echo "- Status: ${{ job.status }}";
            echo "- Original Prod Database: \`${BASE_DEPLOYMENT_ID:-n/a}\`";
            echo "- Snapshot ID: \`${SNAPSHOT_ID:-n/a}\`";
            echo "- Clone database: \`${CLONE_DEPLOYMENT_ID:-n/a}\`";
            echo "- Steps:";
            echo "  - \`guepard list deployments --json\` (select base deployment)";
            echo "  - \`guepard list branches -x \$BASE_DEPLOYMENT_ID --json\` (get main branch ID)";
            echo "  - \`guepard commit --deployment-id \$BASE_DEPLOYMENT_ID --branch-id \$BRANCH_ID --json\` (create snapshot)";
            echo "  - \`guepard clone -x \$BASE_DEPLOYMENT_ID -s \$SNAPSHOT_ID --json\` (create clone)";
            echo "  - Wait for compute to be healthy";
            echo "  - \`prisma migrate deploy\` (apply migrations to clone)";
            echo "  - Seed test data with new format";
            echo "  - Prisma invariants tests against migrated + seeded clone";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Drop CI database
        if: always()
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          if [ -n "${CLONE_DEPLOYMENT_ID:-}" ]; then
            echo "Cleaning up clone deployment: $CLONE_DEPLOYMENT_ID"
            echo "ðŸ” Executing: guepard deploy -x $CLONE_DEPLOYMENT_ID -y"
            guepard deploy -x "$CLONE_DEPLOYMENT_ID" -y || echo "Clone cleanup failed (possibly already removed)"
          else
            echo "CLONE_DEPLOYMENT_ID not set, nothing to clean up"
          fi

  api-contract-tests:
    name: API contract tests
    needs:
      - db-integration-tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies (api)
        working-directory: components/api
        run: pnpm install --frozen-lockfile

      - name: Run API contract tests
        env:
          TEST_MODE: contract
        working-directory: components/api
        run: pnpm test

      - name: CI summary - API contract tests
        if: always()
        run: |
          {
            echo "### API contract tests";
            echo "";
            echo "- Status: ${{ job.status }}";
            echo "- Directory: \`components/api\`";
            echo "- Command: \`pnpm test\` (with TEST_MODE=contract)";
          } >> "$GITHUB_STEP_SUMMARY"