name: Preview Environment

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number (used for preview DB/env naming)"
        required: true
        type: number
      action:
        description: "Action to perform"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - cleanup

env:
  GUEPARD_TOKEN: ${{ secrets.GUEPARD_TOKEN }}
  PR_ID: ${{ inputs.pr_number }}

jobs:
  preview:
    if: inputs.action == 'deploy'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Clone database
        run: |
          guepard db clone \
            --source prod-db \
            --target preview-db-pr-${PR_ID}

      - name: Apply migrations
        run: |
          guepard db migrate preview-db-pr-${PR_ID} \
            --migrations ./migrations

      - name: Schema compatibility check
        run: |
          guepard db diff prod-db preview-db-pr-${PR_ID} \
            --fail-on-breaking

      - name: Deploy preview API
        run: |
          ./deploy-api.sh preview-db-pr-${PR_ID}

      - name: API tests
        run: npm run test:api

      - name: Deploy preview frontend
        run: ./deploy-frontend.sh ${PR_ID}

      - name: E2E tests
        run: npm run test:e2e

  cleanup:
    if: inputs.action == 'cleanup'
    runs-on: ubuntu-latest

    steps:
      - name: Remove preview DB
        run: |
          guepard db drop preview-db-pr-${PR_ID}
